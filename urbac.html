<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Dancer::Plugin::uRBAC - micro Role Based Access Control</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<body style="background-color: white">


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#version">VERSION</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<ul>

		<li><a href="#rights">rights</a></li>
		<li><a href="#say_if_debug">say_if_debug</a></li>
		<li><a href="#history">history</a></li>
		<li><a href="#_______before">хук before</a></li>
		<li><a href="#_______before_template_render">хук before_template_render</a></li>
		<li><a href="#rights">rights</a></li>
		<li><a href="#access_status">access_status</a></li>
		<li><a href="#access_deny">access_deny</a></li>
		<li><a href="#access_grant">access_grant</a></li>
	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<p>
</p>
<hr />
<h1><a name="name">NAME</a></h1>
<p>Dancer::Plugin::uRBAC - micro Role Based Access Control</p>
<p>
</p>
<hr />
<h1><a name="version">VERSION</a></h1>
<p>0.2</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Опишите конфигурацию доступа к различным точкам.</p>
<pre>
    config.yml:
        ...
        plugins:
            uRBAC:
            roles:
                /: any
                /page/:url: any
                /page/:url/edit: admin
        ...</pre>
<p>Подключите модуль:</p>
<pre>
    use Dancer::Plugin::uRBAC;</pre>
<p>В общем шаблоне выполняйте проверку прав доступа и отрисовку странички запрещения
(для TemplateToolkit):</p>
<pre>
    [% IF deny_flag != 0; INCLUDE $deny_template; ELSE; content; END %]</pre>
<p>В теле основного проекта можно использовать проверку ролей...</p>
<pre>
    get '/' =&gt; sub {
        ...
        if (rights('admin') {
            warning &quot; ::::::::::::::::: your are is admin' rights&quot;;
        } else {
            warning &quot; ::::::::::::::::: your are isn't admin&quot;;
        }
        ...
    }</pre>
<p>... и модификацию прав доступа согласно иной логики:</p>
<pre>
    get '/page/:url' =&gt; sub {
        ...</pre>
<pre>
        if ( foo ) {
            access_deny;
        } else {
            access_grant;
        }</pre>
<pre>
    }</pre>
<p>В шаблоне возможно проверять права текущего пользователя следующим образом:</p>
<pre>
    [% IF rights(admin) %]&lt;a href=&quot;modify&quot;&gt;изменить содержимое&lt;/a&gt;[% END %]</pre>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>Плагин, добавляющий в Dancer функционал контроля на основе ролей.</p>
<p>При подключении модуля устанавливается два хука: перед вызовом и при отрисовке
шаблона. Кроме того, управлять поведением запрещения можно с помощью
экспортируемых процедур.</p>
<p>При работе модуля используются следующие внешние точки и соглашения:</p>
<p>- session-&gt;{user}-&gt;{roles} хранит список ролей текущего пользователя;</p>
<p>- если роль не определена, она считается гостевой (guest);</p>
<p>- шаблон запрещения находится в views/components/defdeny.tt;</p>
<p>- шаблон запрещения можно переопределить опцией deny_template в конфиге модуля;</p>
<p>- проверять права можно прямо в шаблонизаторе, для этого в него передаётся
ссылка на процедуру rights;</p>
<p>
</p>
<h2><a name="rights">rights</a></h2>
<p>Сердце модуля - процедура проверки прав доступа. На входе не передаётся
никаких параметров, а на выходе возвращается 1, если доступ запрещается или
undef, если разрешается</p>
<p>
</p>
<h2><a name="say_if_debug">say_if_debug</a></h2>
<p>Для удобства отладки зависимый от флага отладки вывод флага отладки</p>
<p>
</p>
<h2><a name="history">history</a></h2>
<p>Запись истории посещения в лог. Если указан комментарий, то пишем историю не в
лог, а в таблицу БД.</p>
<p>
</p>
<h2><a name="_______before">хук before</a></h2>
<p>Основной механизм установки прав на основе конфигурации и правил.</p>
<p>Перед вызовом логики работы каждой точки мы инициируем базовые переменные. На
основе внешнего модуля FAW::uRoles и конфигурации config.yaml мы выполняем проверки 
прав доступа текущего пользователя к текущей точке и устанавливаем флаг доступа.</p>
<p>
</p>
<h2><a name="_______before_template_render">хук before_template_render</a></h2>
<p>Для корректной работы с правами в шаблонизаторе мы должны передать туда
текущее состояние флага запрещения, адрес шаблона с текстом запрещения и ссылку
на процедуру прав доступа.</p>
<p>
</p>
<h2><a name="rights">rights</a></h2>
<p>Проверить права доступа текущего пользователя к текущему контенту можно 
и прямо в процедуре контента, для этого регистрируется ключевое слово rights.</p>
<p>На входе следует передать название роли, на которую следует проверить
текущего пользователя.</p>
<pre>
    my $currights = rights('admin);</pre>
<p>Проверка не меняет текущий статус. Для этого следует использовать другие
процедуры.</p>
<p>
</p>
<h2><a name="access_status">access_status</a></h2>
<p>Запросить текущий статус (возвращает текущий статус: 1 = блокируется, 0 =
доступно).</p>
<p>
</p>
<h2><a name="access_deny">access_deny</a></h2>
<p>Назначить статус &quot;доступ заблокирован&quot;.</p>
<p>
</p>
<h2><a name="access_grant">access_grant</a></h2>
<p>Назначить статус &quot;доступ разрешён&quot;.</p>

</body>

</html>
